<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUMDes Campurejo - Laying Management v4.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2e7d32; --header-bg: #1b5e20; --bg: #f0f2f5; --accent: #ffa000; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); color: #333; padding-bottom: 90px; }
        
        header { background: var(--header-bg); color: white; padding: 25px 15px; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h2 { margin: 0; font-size: 20px; letter-spacing: 0.5px; }
        header small { opacity: 0.9; font-size: 14px; display: block; margin-top: 4px; }

        .container { padding: 15px; max-width: 500px; margin: auto; }
        
        /* Dashboard Card */
        .card { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .stat-box { background: #f1f8e9; border: 1px solid #e8f5e9; padding: 15px 10px; border-radius: 12px; text-align: center; }
        .stat-box h4 { margin: 0; font-size: 11px; color: #666; text-transform: uppercase; }
        .stat-box p { margin: 8px 0 0; font-weight: bold; color: #2e7d32; font-size: 18px; }

        .analisa-box { background: #fff8e1; border-left: 5px solid #ffa000; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .progress-container { background: #e0e0e0; border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: var(--primary); height: 100%; width: 0%; transition: 0.5s; }

        /* Form */
        label { font-size: 12px; font-weight: 600; color: #555; display: block; margin-top: 12px; }
        input { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #fafafa; font-size: 14px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
        .btn-save { background: var(--header-bg); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }

        /* Table */
        .table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        table th { background: #f5f5f5; padding: 10px; border: 1px solid #eee; }
        table td { padding: 10px; border: 1px solid #eee; text-align: center; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); height: 75px; z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #9e9e9e; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: #2e7d32; font-weight: bold; }
        .nav-item i { display: block; font-size: 22px; margin-bottom: 4px; }

        .hidden { display: none; }
        @media print { nav, button, .no-print { display: none !important; } .card { box-shadow: none; border: 1px solid #ddd; } }
    </style>
</head>
<body>

<header>
    <h2 id="head-nama">BUMDes Campurejo</h2>
    <small id="head-alamat">Ketahanan Pangan - Manajemen Layer</small>
</header>

<div class="container">
    <div id="sec-dash">
        <div class="card grid">
            <div class="stat-box"><h4>Stok Ayam</h4><p id="st-ayam">1000</p></div>
            <div class="stat-box"><h4>Stok Pakan</h4><p><span id="st-pakan">0</span> <small>kg</small></p></div>
            <div class="stat-box"><h4>Kas Ops</h4><p id="st-kas">Rp 0</p></div>
            <div class="stat-box"><h4>Dana Pullet</h4><p id="st-pullet">Rp 0</p></div>
        </div>

        <div class="card">
            <label style="font-size: 14px; margin-top: 0;">Status Pengembalian Modal (ROI):</label>
            <div id="analisa-content" class="analisa-box">
                <div id="analisa-text">Memuat analisa...</div>
                <div class="progress-container"><div id="roi-bar" class="progress-bar"></div></div>
                <small id="roi-text" style="font-size: 10px; color: #666;"></small>
            </div>
        </div>
    </div>

    <div id="sec-input" class="hidden">
        <div class="card">
            <h3 style="margin-top:0">Input Produksi</h3>
            <label>Tanggal</label><input type="date" id="in-tgl">
            <label>Telur Layak Jual (Kg)</label><input type="number" id="in-kg" step="0.01" placeholder="Berat telur bagus">
            <label>Telur Rusak/BS (Butir)</label><input type="number" id="in-rusak" placeholder="0">
            <label>Pakan Terpakai (Kg)</label><input type="number" id="in-pakan" step="0.1" placeholder="Pakan hari ini">
            <label>Harga Jual (Rp/Kg)</label><input type="number" id="in-harga" placeholder="Harga pasar">
            <button class="btn-save" onclick="simpanHarian()">Simpan Data</button>
        </div>
    </div>

    <div id="sec-rekap" class="hidden">
        <div class="card" id="print-area">
            <h3 style="text-align:center; margin-top:0">LAPORAN PRODUKSI</h3>
            <div class="table-container">
                <table id="table-rekap">
                    <thead>
                        <tr><th>Tgl</th><th>Kg Jual</th><th>BS</th><th>FCR</th><th>BEP</th><th>Omzet</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="rekap-total" style="margin-top:15px; font-size:12px; font-weight:bold; line-height:1.6"></div>
        </div>
        <button class="btn-save" onclick="window.print()"><i class="fa fa-print"></i> Cetak PDF</button>
        <button class="btn-save" style="background:#2e7d32" onclick="exportExcel()"><i class="fa fa-file-excel"></i> Export Excel</button>
    </div>

    <div id="sec-admin" class="hidden">
        <div class="card">
            <h3>Modal & Histori</h3>
            <label>Total Modal Investasi (Rp)</label>
            <input type="number" id="set-modal-awal" placeholder="Contoh: 100000000">
            <label>Profit Akumulasi Sebelum App (Rp)</label>
            <input type="number" id="set-profit-lalu" placeholder="Total untung Minggu 17-33">
            <label>Harga Pakan (Rp/Kg)</label>
            <input type="number" id="set-h-pakan" value="7500">
            <label>Biaya Ops/Hari (Rp)</label>
            <input type="number" id="set-ops" value="50000">
            <button class="btn-save" onclick="saveSettings()">Simpan Konfigurasi</button>
        </div>

        <div class="card">
            <h3>Backup / Restore</h3>
            <button class="btn-outline" onclick="backupData()"><i class="fa fa-download"></i> Download Backup (.json)</button>
            <label>Restore dari File</label>
            <input type="file" id="importFile" accept=".json" style="font-size:11px">
            <button class="btn-outline" onclick="importData()"><i class="fa fa-upload"></i> Upload & Restore</button>
        </div>

        <div class="card">
            <h3>Populasi</h3>
            <label>Jumlah Ayam (Ekor)</label><input type="number" id="set-ayam">
            <label>Tambah Pakan (Kg)</label><input type="number" id="set-pakan-tambah">
            <button class="btn-save" style="background:#fb8c00" onclick="updateStok()">Update Populasi</button>
        </div>
        <button onclick="resetData()" style="background:#e53935; color:white; font-size:11px; margin-top:10px">RESET TOTAL</button>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="nav(this, 'dash')"><i class="fa fa-home"></i>Dash</div>
    <div class="nav-item" onclick="nav(this, 'input')"><i class="fa fa-plus-circle"></i>Input</div>
    <div class="nav-item" onclick="nav(this, 'rekap')"><i class="fa fa-list-alt"></i>Rekap</div>
    <div class="nav-item" onclick="nav(this, 'admin')"><i class="fa fa-database"></i>Admin</div>
</nav>

<script>
    let db = JSON.parse(localStorage.getItem('bumdes_v45_pro')) || {
        config: { modalAwal: 0, profitLalu: 0, hPakan: 7500, ops: 50000, tglMasuk: "2025-10-10", usiaAwal: 16 },
        stok: { ayam: 1000, pakan: 0, kas: 0, pullet: 0, totalProfitApp: 0 },
        logs: []
    };

    function nav(el, target) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        ['dash', 'input', 'rekap', 'admin'].forEach(s => document.getElementById('sec-'+s).classList.add('hidden'));
        document.getElementById('sec-'+target).classList.remove('hidden');
        if(target === 'rekap') renderRekap();
    }

    function updateUI() {
        document.getElementById('st-ayam').innerText = db.stok.ayam;
        document.getElementById('st-pakan').innerText = db.stok.pakan.toFixed(1);
        document.getElementById('st-kas').innerText = "Rp " + Math.round(db.stok.kas).toLocaleString();
        document.getElementById('st-pullet').innerText = "Rp " + Math.round(db.stok.pullet).toLocaleString();
        
        // Umur Ayam
        const tglRef = new Date(db.config.tglMasuk);
        const selisihMgg = Math.floor(((new Date()) - tglRef) / (1000 * 60 * 60 * 24 * 7));
        const umur = db.config.usiaAwal + selisihMgg;

        // Analisa ROI
        const totalProfitGlobal = db.stok.totalProfitApp + (db.config.profitLalu || 0);
        const persenROI = db.config.modalAwal > 0 ? (totalProfitGlobal / db.config.modalAwal * 100) : 0;
        
        document.getElementById('roi-bar').style.width = Math.min(persenROI, 100) + "%";
        document.getElementById('roi-text').innerText = `Progres: ${persenROI.toFixed(1)}% (Rp ${Math.round(totalProfitGlobal).toLocaleString()} / Rp ${db.config.modalAwal.toLocaleString()})`;

        document.getElementById('analisa-text').innerHTML = `
            Umur: <b>${umur} Mgg</b> | Afkir: <b>${80-umur} Mgg lagi</b><br>
            FCR: <b>${(db.logs.length ? db.logs[db.logs.length-1].fcr : 0).toFixed(2)}</b>
        `;
        localStorage.setItem('bumdes_v45_pro', JSON.stringify(db));
    }

    function simpanHarian() {
        const kg = parseFloat(document.getElementById('in-kg').value);
        const pakan = parseFloat(document.getElementById('in-pakan').value);
        const harga = parseFloat(document.getElementById('in-harga').value);
        if(!kg || !pakan || !harga) return alert("Mohon lengkapi data!");

        const costProd = (pakan * db.config.hPakan) + db.config.ops;
        const profitHariIni = (kg * harga) - costProd;
        const tabPullet = kg * 1000;

        db.logs.push({ 
            tgl: document.getElementById('in-tgl').value, kg, pakan, harga, 
            rusak: document.getElementById('in-rusak').value || 0,
            fcr: pakan/kg, hpp: costProd/kg,
            totalJual: kg*harga
        });

        db.stok.pakan -= pakan;
        db.stok.kas += ((kg * harga) - tabPullet);
        db.stok.pullet += tabPullet;
        db.stok.totalProfitApp += profitHariIni;

        updateUI();
        alert("Data Tersimpan!");
        nav(document.querySelector('.nav-item'), 'dash');
    }

    function renderRekap() {
        const tbody = document.querySelector('#table-rekap tbody');
        tbody.innerHTML = "";
        let tKg = 0, tUang = 0, tRusak = 0;
        db.logs.slice().reverse().forEach(l => {
            tKg += l.kg; tUang += l.totalJual; tRusak += parseInt(l.rusak);
            tbody.innerHTML += `<tr><td>${l.tgl}</td><td>${l.kg}</td><td>${l.rusak}</td><td>${l.fcr.toFixed(2)}</td><td>${Math.round(l.hpp)}</td><td>${l.totalJual.toLocaleString()}</td></tr>`;
        });
        document.getElementById('rekap-total').innerHTML = `PRODUKSI: ${tKg.toFixed(1)} Kg | BS: ${tRusak} Btr<br>OMZET: Rp ${tUang.toLocaleString()}`;
    }

    function saveSettings() {
        db.config.modalAwal = parseFloat(document.getElementById('set-modal-awal').value) || 0;
        db.config.profitLalu = parseFloat(document.getElementById('set-profit-lalu').value) || 0;
        db.config.hPakan = parseFloat(document.getElementById('set-h-pakan').value);
        db.config.ops = parseFloat(document.getElementById('set-ops').value);
        updateUI();
        alert("Pengaturan Berhasil Disimpan!");
    }

    function updateStok() {
        if(document.getElementById('set-ayam').value) db.stok.ayam = document.getElementById('set-ayam').value;
        db.stok.pakan += parseFloat(document.getElementById('set-pakan-tambah').value) || 0;
        updateUI();
        alert("Stok Populasi & Pakan Diupdate!");
    }

    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchorAnchor.setAttribute("download", "BUMDes_Backup.json");
        downloadAnchor.click();
    }

    function importData() {
        const file = document.getElementById('importFile').files[0];
        if (!file) return alert("Pilih file backup!");
        const reader = new FileReader();
        reader.onload = function(e) {
            db = JSON.parse(e.target.result);
            updateUI();
            alert("Data Berhasil di-Restore!");
        };
        reader.readAsText(file);
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db.logs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan");
        XLSX.writeFile(wb, "Laporan_BUMDes.xlsx");
    }

    function resetData() { if(confirm("Hapus semua data?")) { localStorage.clear(); location.reload(); } }
    
    document.getElementById('in-tgl').valueAsDate = new Date();
    updateUI();
</script>
</body>
</html>
